@{
    Layout = "_ProducerLayout";
    var sidebarItems = ViewBag.SidebarItems as List<SidebarViewModel>;

    var antiforgery = Context.RequestServices.GetService<Microsoft.AspNetCore.Antiforgery.IAntiforgery>();
    var tokenSet = antiforgery.GetAndStoreTokens(Context);
}

<div class="layout-container">
    <div class="toolbar-container">
        <ejs-toolbar id="toolbar">
            <e-toolbar-items>
                <e-toolbar-item prefixIcon="bi bi-list" cssClass="menu-button" id="menu-toggle"></e-toolbar-item>
                <e-toolbar-item text="Harvestica" cssClass="app-title"></e-toolbar-item>
                <e-toolbar-item template="<div class='toolbar-right-items'>
                    <div class='notification-item'>
                        <div class='notification-badge'></div>
                        <i class='bi bi-bell'></i>
                    </div>
                    <div class='notification-item'>
                        <div class='notification-badge'></div>
                        <i class='bi bi-chat-dots'></i>
                    </div>
                    <div class='avatar-container'>
                        <img src='@ViewBag.AvatarUrl' alt='User Avatar' class='user-avatar' id='userAvatar'>
                        <div class='user-info'>
                            <div class='user-name'>@ViewBag.FullName</div>
                            <div class='user-role'>Producer</div>
                        </div>
                        <input type='file' id='photoInput' accept='image/*' style='display:none;' />
                    </div>
                    <form action='/Account/Logout'
                          method='post'
                          class='logout-form'
                          id='logoutForm'
                          style='margin-left:8px;'>
                        <input type='hidden' name='__RequestVerificationToken' value='@tokenSet.RequestToken' />
                        <button type='button' id='logoutBtn' class='logout-button' title='Logout'>
                            <i class='bi bi-box-arrow-right'></i> Logout
                        </button>
                    </form>
                </div>" cssClass="toolbar-right">
                </e-toolbar-item>
            </e-toolbar-items>
        </ejs-toolbar>
    </div>

    <div class="content-wrapper">
        <div id="sidebar-wrapper">
            <ejs-sidebar id="sidebarObj" Width="260px" Position="Left" target="#contentArea" type="Push">
                <e-content-template>
                    <div id="sidebar-menu">
                        @if (sidebarItems != null)
                        {
                            @foreach (var item in sidebarItems)
                            {
                                <div class="menu-item @(item.Id == ViewBag.ActiveItemId ? "active" : "")" onclick="navigateTo('@item.Url', '@item.Id')">
                                    <div class="menu-item-content">
                                        <i class="menu-item-icon @item.IconCss"></i>
                                        <span class="menu-item-text">@item.Name</span>
                                    </div>
                                    @if (item.IsPro)
                                    {
                                        <span class="pro-badge">Pro</span>
                                    }
                                </div>
                            }
                        }

                        <div class="upgrade-pro-container">
                            <div class="upgrade-pro-logo">
                                <i class="bi bi-gem"></i>
                            </div>
                            <h3>Upgrade to PRO</h3>
                            <p>Improve your development process and start doing more with Harvestica PRO!</p>
                            <button class="upgrade-button" onclick="window.location.href='/Subscription/Upgrade'">
                                Upgrade to PRO
                            </button>
                        </div>
                    </div>
                </e-content-template>
            </ejs-sidebar>
        </div>

        <div id="contentArea">
            @RenderBody()
            @RenderSection("Scripts", required: false)
        </div>
    </div>
</div>

<div id="logoutConfirmDialog"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var sidebar = document.getElementById('sidebarObj').ej2_instances[0];

        document.getElementById('menu-toggle').addEventListener('click', function () {
            sidebar.toggle();
        });

        // Avatar click to open file input
        document.getElementById('userAvatar').addEventListener('click', function () {
            document.getElementById('photoInput').click();
        });

        // Handle file selection and upload
        document.getElementById('photoInput').addEventListener('change', function () {
            if (this.files && this.files[0]) {
                var formData = new FormData();
                formData.append('photo', this.files[0]);

                const avatarImg = document.getElementById('userAvatar');
                const originalSrc = avatarImg.src;

                fetch('/Account/UploadPhoto', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server returned ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Update avatar image if successful
                            avatarImg.src = data.imageUrl;
                        } else {
                            console.error('Upload failed:', data.message);
                            alert('Upload failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred during upload. Please try again later.');
                    });
            }
        });

        var dialogObj = new ej.popups.Dialog({
            header: 'Confirm Logout',
            content: '<div class="logout-question-container">' +
                '<div class="logout-question-text">Are you sure you want to logout?</div>' +
                '</div>',
            showCloseIcon: false,
            width: '350px',
            isModal: true,
            visible: false,
            target: document.body,
            cssClass: 'logout-dialog rounded-dialog',
            buttons: [
                {
                    click: function () {
                        dialogObj.hide();
                    },
                    buttonModel: {
                        content: 'NO',
                        isPrimary: false,
                        cssClass: 'e-flat no-btn'
                    }
                },
                {
                    click: function () {
                        document.getElementById('logoutForm').submit();
                    },
                    buttonModel: {
                        content: 'YES',
                        isPrimary: true,
                        cssClass: 'e-flat yes-btn'
                    }
                }
            ],
            position: { X: 'center', Y: 'center' }
        });

        dialogObj.appendTo('#logoutConfirmDialog');

        document.getElementById('logoutBtn').addEventListener('click', function () {
            dialogObj.show();
        });
    });

    function navigateTo(url, id) {
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });

        document.querySelector(`.menu-item[onclick*='${id}']`).classList.add('active');

        window.location.href = url;
    }
</script>