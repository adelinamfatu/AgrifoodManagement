@using AgrifoodManagement.Util.Models;

@{
    Layout = "~/Views/Shared/_ProducerSidebarLayout.cshtml";

    var productCategoriesData = ViewBag.ProductCategories as List<CategoryNode>;

    var sortOptions = new[] { "Expiration Date", "Price: High to Low", "Price: Low to High", "Quantity" };
}

@model List<UpsertProductViewModel>

<div class="announcement-container">
    <div class="search-filter-row">
        <div class="search-area">
            <i class="fa fa-search search-icon"></i>
            <ejs-textbox id="searchBox"
                placeholder="Search your listings..."
                floatLabelType="Auto">
            </ejs-textbox>
        </div>

        <div class="filter-options">
            <ejs-dropdownlist id="productCategories"
                              dataSource="@productCategoriesData"
                              placeholder="Select a product category"
                              index="0"
                              popupHeight="220px"
                              change="categoryValueChange">
                <e-dropdownlist-fields text="Category" value="Id"></e-dropdownlist-fields>
            </ejs-dropdownlist>

            <ejs-button id="addNewButton" content='<i class="fa fa-plus"></i> ADD NEW' onclick="navigateToProductPage()"></ejs-button>
        </div>
    </div>

    <ejs-chiplist id="chip-default">
        <e-chips>
            <e-chip text="Active" cssClass="e-primary" enabled="true" value="active"></e-chip>
            <e-chip text="Expiring Soon" cssClass="e-warning" enabled="true" value="expiring"></e-chip>
            <e-chip text="Low Stock" cssClass="e-danger" enabled="true" value="lowStock"></e-chip>
            <e-chip text="Archived" cssClass="e-secondary" enabled="true" value="archived"></e-chip>
        </e-chips>
    </ejs-chiplist>

    <div class="results-header">
        <p id="listingCount">Showing @Model.Count active listings</p>

        <div class="view-options">
            <div class="sort-dropdown">
                <ejs-dropdownlist id="sortDropdown"
                                  dataSource="@sortOptions"
                                  placeholder="Sort by">
                </ejs-dropdownlist>
            </div>
        </div>
    </div>

    <div class="products-container">
        @foreach (var product in Model)
        {
            <div class="product-card"
                 data-expiration="@product.ExpirationDate.ToString("o")"
                 data-category-id="@product.Category"
                 data-price="@product.Price"
                 data-status="@product.AnnouncementStatus"
                 data-quantity="@product.Quantity">
                <div class="product-header">
                    @if (product.PhotoUrls != null && product.PhotoUrls.Count > 0)
                    {
                        <img src="@product.PhotoUrls[0]" alt="@product.Name" class="product-image" />
                    }
                    else
                    {
                        <img src="/images/product-placeholder.png" alt="@product.Name" class="product-image" />
                    }

                    <div class="product-header-controls">
                        <button class="manage-btn" onclick="navigateToProductPage('@product.Id')" title="Manage Product">
                            <i class="fa fa-cog"></i> Manage
                        </button>

                        @if (!product.IsPromoted)
                        {
                            <button class="promote-btn" onclick="promoteProduct(@product.Id)">
                                <i class="fa fa-bullhorn"></i> Promote
                            </button>
                        }
                    </div>
                </div>

                <div class="product-content">
                    <div class="product-title-section">
                        <h3 class="product-name">@product.Name</h3>
                        <div class="product-controls">
                            <button class="edit-btn" title="Edit Listing"><i class="fa fa-pencil"></i></button>
                            <button class="archive-btn" title="Archive Listing"><i class="fa fa-archive"></i></button>
                        </div>
                    </div>

                    <div class="status-and-quantity">
                        <div class="status-badge @product.AnnouncementStatus.ToString().ToLower()">
                            @product.AnnouncementStatus
                        </div>

                        <div class="quantity-badge">
                            <i class="fa fa-balance-scale"></i> @product.Quantity @product.UnitOfMeasurement
                        </div>
                    </div>

                    <div class="product-price">$@product.Price.ToString("0.00") per @product.UnitOfMeasurement</div>

                    <p class="product-description">@product.Description</p>

                    <div class="product-details">
                        <div class="detail">
                            <i class="fa fa-calendar"></i>
                            <span>Expires: @product.ExpirationDate.ToString("MMM dd, yyyy")</span>
                            @if ((product.ExpirationDate - DateTime.Now).TotalDays < 7)
                            {
                                <span class="warning-tag">Expiring Soon</span>
                            }
                        </div>
                        <div class="detail">
                            <i class="fa fa-tag"></i>
                            <span>Category: @product.CategoryName</span>
                        </div>
                    </div>

                    <div class="product-footer">
                        <div class="metrics">
                            <div class="metric">
                                <span class="metric-value">12</span>
                                <span class="metric-label">Views</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">3</span>
                                <span class="metric-label">Inquiries</span>
                            </div>
                            <div class="suggested-price-tag">
                                Est. Market: $@((product.Price * 1.15m).ToString("0.00"))
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Search by name and/or description
        var searchElem = document.getElementById("searchBox");
        if (searchElem && searchElem.ej2_instances && searchElem.ej2_instances[0]) {
            var searchTb = searchElem.ej2_instances[0];
            searchTb.change = function (args) {
                var term = (args.value || "").trim().toLowerCase();
                document.querySelectorAll(".product-card").forEach(function (card) {
                    var name = card.querySelector(".product-name").textContent.toLowerCase();
                    var desc = card.querySelector(".product-description").textContent.toLowerCase();
                    card.style.display = (!term || name.includes(term) || desc.includes(term))
                        ? "" : "none";
                });
            };

            updateActiveListingsCount();
        }

        //Sort dropdown
        var sortDd = document
            .getElementById("sortDropdown")
            .ej2_instances[0];

        sortDd.change = function (e) {
            var sel = e.itemData.value;
            var container = document.querySelector(".products-container");
            var cards = Array.from(container.querySelectorAll(".product-card"));
            var sorted;

            switch (sel) {
                case "Expiration Date":
                    sorted = cards.sort(function (a, b) {
                        return new Date(a.dataset.expiration)
                            - new Date(b.dataset.expiration);
                    });
                    break;
                case "Price: High to Low":
                    sorted = cards.sort(function (a, b) {
                        return parseFloat(b.dataset.price)
                            - parseFloat(a.dataset.price);
                    });
                    break;
                case "Price: Low to High":
                    sorted = cards.sort(function (a, b) {
                        return parseFloat(a.dataset.price)
                            - parseFloat(b.dataset.price);
                    });
                    break;
                case "Quantity":
                    sorted = cards.sort(function (a, b) {
                        return parseInt(b.dataset.quantity)
                            - parseInt(a.dataset.quantity);
                    });
                    break;
                default:
                    sorted = cards;
            }

            container.innerHTML = "";
            sorted.forEach(function (card) {
                container.appendChild(card);
            });
        };

        // Chip filter
        var chips = document.querySelectorAll('#chip-default .e-chip');
        chips.forEach(function (chip) {
            chip.addEventListener('click', function () {
                var status = chip.getAttribute('data-value');

                document.querySelectorAll(".product-card").forEach(function (card) {
                    var productStatus = card.getAttribute("data-status").toLowerCase();
                    var expirationDate = new Date(card.dataset.expiration);
                    var stockQuantity = parseInt(card.dataset.quantity);

                    if (status === 'active' && productStatus === 'published') {
                        card.style.display = "";
                    } else if (status === 'expiring' && (expirationDate - new Date()) < 14 * 24 * 60 * 60 * 1000) {
                        card.style.display = "";
                    } else if (status === 'lowStock' && stockQuantity < 21) {
                        card.style.display = "";
                    } else if (status === 'archived' && (productStatus === 'archived'
                                                            || productStatus === 'expired')) {
                        card.style.display = "";
                    } else {
                        card.style.display = "none";
                    }
                });

                updateActiveListingsCount();
            });
        });
    });

    // Update active listings count
    function updateActiveListingsCount() {
        var visibleProducts = document.querySelectorAll(".product-card:not([style*='display: none'])");
        document.getElementById("listingCount").innerText = "Showing " + visibleProducts.length + " listings";
    }

    function categoryValueChange(args) {
        var selectedCategoryId = args.value?.toString();

        document.querySelectorAll(".product-card").forEach(function (card) {
            var cardCategoryId = card.getAttribute("data-category-id")?.toString();
            card.style.display = (!selectedCategoryId || cardCategoryId === selectedCategoryId)
                ? "" : "none";
        });

        updateActiveListingsCount();
    }

    function navigateToProductPage(productId) {
        try {
            if (productId) {
                window.location.href = "/Producer/Product?id=" + productId;
            } else {
                window.location.href = "/Producer/Product";
            }
        } catch (error) {
            console.error("Error during navigation:", error);
        }
    }

    function promoteProduct(productId) {
        // Handle promote logic
    }
</script>